{% extends "index.html" %}

{% block title %}
Gestione account
{% endblock %}

{% block content %}

    <h1 class = "text-center">{{ helloMessage }}, {{ session['name'] }}!</h1>
    
    <section class = "flex justify-center flex-wrap gap-5">
        <div class = "container blue mt-3">
            <div class = "w-1/2 text-center">
                <b>{{ session['role'] }}</b>
                <p class = "mt-1 mb-2">Ultima volta online: {{session['lastLogin']}}</p>
                <a class = "button dark-blue p-1 text-xs" href = "{{url_for('updateUserInfo')}}">Modifica account</a>
            </div>
            <div class = "next-lesson">
                {% if session['role'] in ['Admin', 'Insegnante'] %}
                    <a class = "top-box" href = "{{url_for('manageLesson', id = scheduledLessons['idLezione'])}}">
                        <img src = "{{url_for('static', filename = 'assets/attendance.svg')}}">
                        <p class = "button orange">Registra presenze</p>
                    </a>
                    {% else %}
                    <div class = "top-box">
                        <img src = "{{url_for('static', filename = 'assets/attendance.svg')}}">
                        <!-- TODO: Add attendance check for lesson (student only) -->
                        <p class = "button orange">Presente</p>
                    </div>
                {% endif %}
                <div class = "lesson-description">
                    <b class = "text-sm">Prossima lezione:</b>
                    <p class = "text-sm">{{scheduledLessons['Materia']}}</p>
                    <p class = "text-sm">Aula {{scheduledLessons['aula']}}</p>
                    <a class = "button dark-blue mt-2" href = "{{url_for('lessonsList')}}">Vedi tutte</a>
                </div>
            </div>
        </div>
        {% if session['role'] == 'Admin' %}
            <a class = "action" href = "{{url_for('createUser')}}">
                <img src = "{{url_for('static', filename = 'assets/user.svg')}}">
                <p class = "button orange">Crea utente</p>
            </a>
            <a class = "action" href = "{{url_for('create_course')}}">
                <img src = "{{url_for('static', filename = 'assets/course.svg')}}">
                <p class = "button orange">Crea corso</p>
            </a>
            <a class = "action" href = "{{url_for('usersList')}}">
                <img src = "{{url_for('static', filename = 'assets/users.svg')}}">
                <p class = "button orange">Lista utenti</p>
            </a>
            {% endif %}
            {% if session['role'] in ['Insegnante', 'Admin'] %}
                <a class = "action" href = "{{url_for('createLesson')}}">
                    <img src = "{{url_for('static', filename = 'assets/teacher.svg')}}">
                    <p class = "button orange">Crea lezione</p>
                </a>
            {% endif %}
            {% if not session['githubConnected'] %}
                <a class = "action" href = "{{url_for('githubAuth')}}">
                    <img src = "{{url_for('static', filename = 'assets/github.svg')}}">
                    <p class = "button orange">Connetti GitHub</p>
                </a>
            {% else %}
                    <a class = "action" href = "{{url_for('unlinkGithubAccount')}}">
                        <img src = "{{url_for('static', filename = 'assets/github.svg')}}">
                        <p class = "button orange">Disconnetti GitHub</p>
                    </a>
            {% endif %}
            {% if not session['googleConnected'] %}
                <a class = "action" href = "{{url_for('googleAuth')}}">
                    <img src = "{{url_for('static', filename = 'assets/google.svg')}}">
                    <p class = "button orange">Connetti Google</p>
                </a>
            {% else %}
                    <a class = "action" href = "{{url_for('unlinkGoogleAccount')}}">
                        <img src = "{{url_for('static', filename = 'assets/google.svg')}}">
                        <p class = "button orange">Disconnetti Google</p>
                    </a>
            {% endif %}
    </section>

    {% if session.get('role') in ['Admin', 'Insegnante'] %}
        <h1 id = "chartTitle">Presenze studenti negli ultimi 7 giorni</h1>
        <canvas id = "attendanceStatistics" width = "400" height = "100" aria-label = "Grafico presenze" role = "img">Il tuo browser non permette la visualizzazione di questo grafico. Per favore prova a usare un browser differente.</canvas>
        <button class = "updateRange" value = '7'>7 Giorni</button>
        <button class = "updateRange" value = '14'>14 Giorni</button>
        <button class = "updateRange" value = '30'>1 Mese</button>
    {% endif %}
    
    {% if session.get('role') == 'Studente' %}
        <h1 id = "percChartTitle">Percentuale presenze negli ultimi 7 giorni</h1>
        <canvas id = "attendancePercentageStatistics" width = "400" height = "100" aria-label = "Grafico presenze" role = "img">Il tuo browser non permette la visualizzazione di questo grafico. Per favore prova a usare un browser differente.</canvas>
        <button class = "percUpdateRange" value = '7'>7 Giorni</button>
        <button class = "percUpdateRange" value = '14'>14 Giorni</button>
        <button class = "percUpdateRange" value = '30'>1 Mese</button>
    {% endif %}

    <a href = "{{ url_for('logout') }}">Logout</a>

    <!-- NOTE: Script declaration -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" integrity="sha512-CQBWl4fJHWbryGE+Pc7UAxWMUMNMWzWxF4SQo9CgkJIN1kx6djDQZjh3Y8SZ1d+6I+1zze6Z7kHXO7q3UyZAWw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    {% if session.get('role') in ['Admin', 'Insegnante'] %}
        <script src = "{{url_for('static', filename = 'script/bar.js')}}"></script>
        <script>
            updateBarChartRange()

            let rangeButtons = document.querySelectorAll('.updateRange');
            rangeButtons.forEach((element) => {
                element.onclick = (() => {
                    updateBarChartRange(element.value)
                })
            });

            function updateBarChartRange(range = 7){
                $.ajax({
                    url: '/lesson/attendances',
                    type: 'GET',
                    contentType: 'application/json',
                    data: {'range': range},
                    success: function(response){
                        updateBarChart(response);
                        document.querySelector('#chartTitle').textContent = `Presenze studenti negli ultimi ${range} giorni`;
                    },
                });
            }
        </script>
    {% endif %}

    {% if session.get('role') == 'Studente' %}
        <script src = "{{url_for('static', filename = 'script/pie.js')}}"></script>
        <script>
            updatePieChartRange()

            let percRangeButtons = document.querySelectorAll('.percUpdateRange');
            percRangeButtons.forEach((element) => {
                element.onclick = (() => {
                    updatePieChartRange(element.value)
                })
            });

            function updatePieChartRange(range = 7){
                $.ajax({
                    url: '/lesson/attendances/percentage',
                    type: 'GET',
                    contentType: 'application/json',
                    data: {'range': range},
                    success: function(response){
                        updatePieChart(response);
                        document.querySelector('#percChartTitle').textContent = `Percentuale presenze negli ultimi ${range} giorni`
                    }
                })
            }
        </script>
    {% endif %}
{% endblock %}