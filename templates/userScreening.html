{% extends "template.html" %}

{% block title %}
Gestione account
{% endblock %}

{% block content %}

    <h1 class = "text-center">{{ helloMessage }}, {{ session['name'] }}!</h1>
    
    <section id = "mainDashboardSection">
        <div class = "container blue mt-3">
            <div class = "w-1/2 text-center">
                <b>{{ session['role'] }}</b>
                <p class = "mt-1 mb-2">Ultima volta online: {{session['lastLogin']}}</p>
                <a class = "button dark-blue p-1 text-xs" href = "{{url_for('updateUserInfo')}}">Modifica account</a>
            </div>
            <div class = "next-lesson">
                {% if session['role'] in ['Admin', 'Insegnante'] %}
                    <a class = "top-box" href = "{{url_for('manageLesson', id = scheduledLessons['idLezione'])}}">
                        <img src = "{{url_for('static', filename = 'assets/attendance.svg')}}">
                        <p class = "button orange">Registra presenze</p>
                    </a>
                    {% else %}
                    <div class = "top-box">
                        <img src = "{{url_for('static', filename = 'assets/attendance.svg')}}">
                        <!-- TODO: Add attendance check for lesson (student only) -->
                        <p class = "button orange">Presente</p>
                    </div>
                {% endif %}
                <div class = "lesson-description">
                    <b class = "text-sm">Prossima lezione:</b>
                    <p class = "text-sm">{{scheduledLessons['Materia']}}</p>
                    <p class = "text-sm">Aula {{scheduledLessons['aula']}}</p>
                    <a class = "button dark-blue mt-2" href = "{{url_for('lessonsList')}}">Vedi tutte</a>
                </div>
            </div>
        </div>
        {% if session['role'] == 'Admin' %}
            <a class = "action" href = "{{url_for('createUser')}}">
                <img src = "{{url_for('static', filename = 'assets/user.svg')}}">
                <p class = "button orange">Crea utente</p>
            </a>
            <a class = "action" href = "{{url_for('create_course')}}">
                <img src = "{{url_for('static', filename = 'assets/course.svg')}}">
                <p class = "button orange">Crea corso</p>
            </a>
            <a class = "action" href = "{{url_for('usersList')}}">
                <img src = "{{url_for('static', filename = 'assets/users.svg')}}">
                <p class = "button orange">Lista utenti</p>
            </a>
            {% endif %}
            {% if session['role'] in ['Insegnante', 'Admin'] %}
                <a class = "action" href = "{{url_for('createLesson')}}">
                    <img src = "{{url_for('static', filename = 'assets/teacher.svg')}}">
                    <p class = "button orange">Crea lezione</p>
                </a>
            {% endif %}
            {% if not session['githubConnected'] %}
                <a class = "action" href = "{{url_for('githubAuth')}}">
                    <img src = "{{url_for('static', filename = 'assets/github.svg')}}">
                    <p class = "button orange">Connetti GitHub</p>
                </a>
            {% else %}
                    <a class = "action" href = "{{url_for('unlinkGithubAccount')}}">
                        <img src = "{{url_for('static', filename = 'assets/github.svg')}}">
                        <p class = "button orange">Disconnetti GitHub</p>
                    </a>
            {% endif %}
            {% if not session['googleConnected'] %}
                <a class = "action" href = "{{url_for('googleAuth')}}">
                    <img src = "{{url_for('static', filename = 'assets/google.svg')}}">
                    <p class = "button orange">Connetti Google</p>
                </a>
            {% else %}
                    <a class = "action" href = "{{url_for('unlinkGoogleAccount')}}">
                        <img src = "{{url_for('static', filename = 'assets/google.svg')}}">
                        <p class = "button orange">Disconnetti Google</p>
                    </a>
            {% endif %}
    </section>

    {% if session.get('role') in ['Admin', 'Insegnante'] %}
        <h1 class = "text-center" id = "chartTitle">üë®‚Äçüéì Presenze studenti negli ultimi 7 giorni üìä</h1>
        <canvas class = "!hidden my-5 mb-10 lg:!block" id = "attendanceStatistics" width = "400" height = "100" aria-label = "Grafico presenze" role = "img">Il tuo browser non permette la visualizzazione di questo grafico. Per favore prova a usare un browser differente.</canvas>
        <div class = "container my-5 text-center lg:hidden">
            <p>Per vedere questo grafico apri la pagina su un Tablet, laptop o PC Desktop</p>
        </div>
        <div class = "hidden flex-wrap gap-2 justify-center items-center lg:flex">
            <button class = "button updateRange" value = '7'>7 Giorni</button>
            <button class = "button updateRange" value = '14'>14 Giorni</button>
            <button class = "button updateRange" value = '30'>1 Mese</button>
        </div>
    {% endif %}
    
    {% if session.get('role') == 'Studente' %}
        <h1 class = "text-center" id = "percChartTitle">üë®‚Äçüéì Percentuale presenze negli ultimi 7 giorni ü•ß</h1>
        <canvas id = "attendancePercentageStatistics" width = "400" height = "100" aria-label = "Grafico presenze" role = "img">Il tuo browser non permette la visualizzazione di questo grafico. Per favore prova a usare un browser differente.</canvas>
        <div class = "flex flex-wrap gap-2 justify-center items-center">
            <button class = "button percUpdateRange" value = '7'>7 Giorni</button>
            <button class = "button percUpdateRange" value = '14'>14 Giorni</button>
            <button class = "button percUpdateRange" value = '30'>1 Mese</button>
        </div>
    {% endif %}

    <!-- NOTE: Script declaration -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" integrity="sha512-CQBWl4fJHWbryGE+Pc7UAxWMUMNMWzWxF4SQo9CgkJIN1kx6djDQZjh3Y8SZ1d+6I+1zze6Z7kHXO7q3UyZAWw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    {% if session.get('role') in ['Admin', 'Insegnante'] %}
        <script src = "{{url_for('static', filename = 'script/bar.js')}}"></script>
        <script>
            updateBarChartRange()

            let rangeButtons = document.querySelectorAll('.updateRange');
            rangeButtons.forEach((element) => {
                element.onclick = (() => {
                    updateBarChartRange(element.value)
                })
            });

            function updateBarChartRange(range = 7){
                $.ajax({
                    url: '/lesson/attendances',
                    type: 'GET',
                    contentType: 'application/json',
                    data: {'range': range},
                    success: function(response){
                        updateBarChart(response);
                        document.querySelector('#chartTitle').textContent = `üë®‚Äçüéì Presenze studenti negli ultimi ${range} giorni üìä`;
                    },
                });
            }
        </script>
    {% endif %}

    {% if session.get('role') == 'Studente' %}
        <script src = "{{url_for('static', filename = 'script/pie.js')}}"></script>
        <script>
            updatePieChartRange()

            let percRangeButtons = document.querySelectorAll('.percUpdateRange');
            percRangeButtons.forEach((element) => {
                element.onclick = (() => {
                    updatePieChartRange(element.value)
                })
            });

            function updatePieChartRange(range = 7){
                $.ajax({
                    url: '/lesson/attendances/percentage',
                    type: 'GET',
                    contentType: 'application/json',
                    data: {'range': range},
                    success: function(response){
                        updatePieChart(response);
                        document.querySelector('#percChartTitle').textContent = `üë®‚Äçüéì Percentuale presenze negli ultimi ${range} giorni ü•ß`
                    }
                })
            }
        </script>
    {% endif %}
    <script>
        //Getting the first action object in order to move it based on screen width (needs to be moved on the right side if the screen is 768px or above)
        var firstChild = document.querySelector('#mainDashboardSection > .action:first-of-type');
        cloneFirstChild()
        window.addEventListener('resize', cloneFirstChild)

        function cloneFirstChild(){
            if(window.screen.width >= 768){
                //Manipulating the `mainDashboardSection` node in order to move the first action block before the `container` class
                firstChild.parentNode.insertBefore(firstChild, document.querySelector('.container'));
            }
            else{
                firstChild.parentNode.insertBefore(firstChild, document.querySelector('.container').nextSibling)
            }
        }
    </script>
{% endblock %}